<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="kr.spring.member.dao.MemberMapper">
	<!-- 회원 가입 -->
	<insert id="insertMember" parameterType="memberVO">
		INSERT INTO member (
			mem_num,
			mem_id,
			mem_nickname) 
		VALUES (
			#{mem_num},
			#{mem_id},
			#{mem_nickname})
	</insert>
	
	<!-- 회원 가입 상세 -->
	<insert id="insertMember_detail" parameterType="memberVO">
		INSERT INTO member_detail (
			mem_num,
			mem_name,
			mem_passwd,
			mem_phone,
			mem_email,
			mem_zipcode,
			mem_address1,
			mem_address2)
		VALUES (
			#{mem_num},
			#{mem_name},
			#{mem_passwd},
			#{mem_phone},
			#{mem_email},
			#{mem_zipcode},
			#{mem_address1},
			#{mem_address2})
	</insert>
	
	<!-- 회원 가입 포인트 -->
	<insert id="insertMember_point" parameterType="memberVO">
		INSERT INTO member_point (
			pt_num,
			mem_num,
			pt_amount,
			pt_status,
			pt_content)
		VALUES (
			#{pt_num},
			#{mem_num},
			'2000',
			'1',
			'회원가입')
	</insert>
	
	<!-- 아이디 중복 체크 및 로그인 체크 -->
	<select id="selectCheckMember" parameterType="String">
		SELECT
			mem_id,
			mem_num,
			mem_auth,
			mem_nickname,
			mem_au_id,
			mem_passwd,
			mem_email
		FROM member LEFT OUTER JOIN member_detail
		USING(mem_num)
		WHERE mem_id=#{id}
	</select>
	
	<!-- 회원 상세 정보 수정 -->
	<update id="updateMember_detail" parameterType="memberVO">
		UPDATE member_detail SET
			mem_email=#{mem_email},
			mem_phone=#{mem_phone},
			mem_zipcode=#{mem_zipcode},
			mem_address1=#{mem_address1},
			mem_address2=#{mem_address2},
			mem_modify_date=SYSDATE
		WHERE mem_num=#{mem_num}
	</update>
	
	<!-- sql 태그와 include 태그를 이용해 SQL문 재사용 -->
	<sql id="pointSearch">
		<where>
			<if test="keyword != null and keyword != ''">
				<if test="keyfield == 1">
					pt_status LIKE #{pt_status}
				</if>
				<if test="keyfield == 2">
					pt_status LIKE #{pt_status}
				</if>
				<if test="keyfield == 3">
					pt_status LIKE #{pt_status}
				</if>
			</if>
		</where>
	</sql>
	<sql id="pointOrder">
		<if test="order == 1">
			ORDER BY pt_reg_date DESC
		</if>
		<if test="order == 2">
			ORDER BY pt_reg_date ASC
		</if>
	</sql>
	
	<!-- 게시판 글의 총개수/검색 개수 -->
	<select id="selectRowCount" parameterType="map" resultType="integer">
		SELECT
			COUNT(*)
		FROM member_point
		WHERE mem_num=#{mem_num}
		<include refid="pointSearch"></include>
	</select>
	
	<!-- 게시판 전체 목록/검색 목록 -->
	<select id="selectPointList" parameterType="map" resultType="memberVO">
		SELECT
			*
		FROM (SELECT
				a.*,
				rownum rnum
			FROM (SELECT
					*
				FROM member_point 
				JOIN member USING(mem_num)
				JOIN member_detail USING(mem_num)
				WHERE mem_num=#{mem_num}
				<include refid="pointSearch"></include>
				<include refid="pointOrder"></include>)a)
			<![CDATA[
		   	WHERE rnum >= #{start} AND rnum <= #{end}
		   	]]>
	</select>
	
</mapper>